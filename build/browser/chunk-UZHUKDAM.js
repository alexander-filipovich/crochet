import{a as $}from"./chunk-B5FSDJQK.js";import{a as z,b as At,d as Bt,e as Nt,f as yt,g as It,h as q,i as Dt,j as Ct,l as Z,m as Ut,n as Gt,o as Pt}from"./chunk-HD423IBN.js";import{E as S,G as V,J as E,M as Tt,N as k,P as Rt,T as X,W as g,Z as T,a as l,aa as xt,b as v,ba as W,ea as R,g as m,ga as j,h as A,ia as K,ka as x,l as w,la as vt,ma as b,pa as Y,s as ut,x as p}from"./chunk-VKNI74MO.js";var B=class{init(){let t=new T({uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uTransformMatrix:{value:new w,type:"mat3x3<f32>"},uRound:{value:0,type:"f32"}}),r=R({name:"graphics",bits:[j,K(16),Y,x]});this.shader=new b({glProgram:r,resources:{localUniforms:t,batchSamplers:$}})}execute(t,r){let s=r.context,o=s.customShader||this.shader,i=t.renderer,n=i.graphicsContext,{geometry:a,instructions:c}=n.getContextRenderData(s);o.groups[0]=i.globalUniforms.bindGroup,i.shader.bind(o),i.geometry.bind(a,o.glProgram);let u=c.instructions;for(let f=0;f<c.instructionSize;f++){let h=u[f];if(h.size){for(let d=0;d<h.textures.textures.length;d++)i.texture.bind(h.textures.textures[d],d);i.geometry.draw("triangle-list",h.size,h.start)}}}destroy(){this.shader.destroy(!0),this.shader=null}};B.extension={type:[m.WebGLPipesAdaptor],name:"graphics"};var N=class{init(){let t=R({name:"mesh",bits:[Y,Bt,x]});this._shader=new b({glProgram:t,resources:{uTexture:E.EMPTY.source,textureUniforms:{uTextureMatrix:{type:"mat3x3<f32>",value:new w}}}})}execute(t,r){let s=t.renderer,o=r._shader;if(o){if(!o.glProgram){p("Mesh shader has no glProgram",r.shader);return}}else{o=this._shader;let i=r.texture,n=i.source;o.resources.uTexture=n,o.resources.uSampler=n.style,o.resources.textureUniforms.uniforms.uTextureMatrix=i.textureMatrix.mapCoord}o.groups[100]=s.globalUniforms.bindGroup,o.groups[101]=t.localUniformsBindGroup,s.encoder.draw({geometry:r._geometry,shader:o,state:r.state})}destroy(){this._shader.destroy(!0),this._shader=null}};N.extension={type:[m.WebGLPipesAdaptor],name:"mesh"};var y=class{constructor(){this._didUpload=!1,this._tempState=g.for2d()}init(t){let r=R({name:"batch",bits:[j,K(16),x]});this._shader=new b({glProgram:r,resources:{batchSamplers:$}}),t.renderer.runners.contextChange.add(this)}contextChange(){this._didUpload=!1}start(t,r){let s=t.renderer;s.shader.bind(this._shader,this._didUpload),s.shader.updateUniformGroup(s.globalUniforms.uniformGroup),s.geometry.bind(r,this._shader.glProgram)}execute(t,r){let s=t.renderer;this._didUpload=!0,this._tempState.blendMode=r.blendMode,s.state.set(this._tempState);let o=r.textures.textures;for(let i=0;i<o.length;i++)s.texture.bind(o[i],i);s.geometry.draw("triangle-list",r.size,r.start)}destroy(){this._shader.destroy(!0),this._shader=null}};y.extension={type:[m.WebGLPipesAdaptor],name:"batch"};var I=(e=>(e[e.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",e[e.ARRAY_BUFFER=34962]="ARRAY_BUFFER",e[e.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",e))(I||{});var Q=class{constructor(t,r){this.buffer=t||null,this.updateID=-1,this.byteLength=-1,this.type=r}};var D=class{constructor(t){this._gpuBuffers=Object.create(null),this._boundBufferBases=Object.create(null),this._renderer=t}destroy(){this._renderer=null,this._gl=null,this._gpuBuffers=null,this._boundBufferBases=null}contextChange(){this._gpuBuffers=Object.create(null),this._gl=this._renderer.gl}getGlBuffer(t){return this._gpuBuffers[t.uid]||this.createGLBuffer(t)}bind(t){let{_gl:r}=this,s=this.getGlBuffer(t);r.bindBuffer(s.type,s.buffer)}bindBufferBase(t,r){let{_gl:s}=this;if(this._boundBufferBases[r]!==t){let o=this.getGlBuffer(t);this._boundBufferBases[r]=t,s.bindBufferBase(s.UNIFORM_BUFFER,r,o.buffer)}}bindBufferRange(t,r,s){let{_gl:o}=this;s=s||0;let i=this.getGlBuffer(t);o.bindBufferRange(o.UNIFORM_BUFFER,r||0,i.buffer,s*256,256)}updateBuffer(t){let{_gl:r}=this,s=this.getGlBuffer(t);if(t._updateID===s.updateID)return s;s.updateID=t._updateID,r.bindBuffer(s.type,s.buffer);let o=t.data;if(s.byteLength>=t.data.byteLength)r.bufferSubData(s.type,0,o,0,t._updateSize/o.BYTES_PER_ELEMENT);else{let i=t.descriptor.usage&k.STATIC?r.STATIC_DRAW:r.DYNAMIC_DRAW;s.byteLength=o.byteLength,r.bufferData(s.type,o,i)}return s}destroyAll(){let t=this._gl;for(let r in this._gpuBuffers)t.deleteBuffer(this._gpuBuffers[r].buffer);this._gpuBuffers=Object.create(null)}onBufferDestroy(t,r){let s=this._gpuBuffers[t.uid],o=this._gl;r||o.deleteBuffer(s.buffer),this._gpuBuffers[t.uid]=null}createGLBuffer(t){let{_gl:r}=this,s=I.ARRAY_BUFFER;t.descriptor.usage&k.INDEX?s=I.ELEMENT_ARRAY_BUFFER:t.descriptor.usage&k.UNIFORM&&(s=I.UNIFORM_BUFFER);let o=new Q(r.createBuffer(),s);return this._gpuBuffers[t.uid]=o,t.on("destroy",this.onBufferDestroy,this),o}};D.extension={type:[m.WebGLSystem],name:"buffer"};var ft=class Ot{constructor(t){this.supports={uint32Indices:!0,uniformBufferObject:!0,vertexArrayObject:!0,srgbTextures:!0,nonPowOf2wrapping:!0,msaa:!0,nonPowOf2mipmaps:!0},this._renderer=t,this.extensions=Object.create(null),this.handleContextLost=this.handleContextLost.bind(this),this.handleContextRestored=this.handleContextRestored.bind(this)}get isLost(){return!this.gl||this.gl.isContextLost()}contextChange(t){this.gl=t,this._renderer.gl=t}init(t){if(t=l(l({},Ot.defaultOptions),t),t.context)this.initFromContext(t.context);else{let r=this._renderer.background.alpha<1,s=t.premultipliedAlpha??!0,o=t.antialias&&!this._renderer.backBuffer.useBackBuffer;this.createContext(t.preferWebGLVersion,{alpha:r,premultipliedAlpha:s,antialias:o,stencil:!0,preserveDrawingBuffer:t.preserveDrawingBuffer,powerPreference:t.powerPreference??"default"})}}initFromContext(t){this.gl=t,this.webGLVersion=t instanceof S.get().getWebGL2RenderingContext()?2:1,this.getExtensions(),this.validateContext(t),this._renderer.runners.contextChange.emit(t);let r=this._renderer.view.canvas;r.addEventListener("webglcontextlost",this.handleContextLost,!1),r.addEventListener("webglcontextrestored",this.handleContextRestored,!1)}createContext(t,r){let s,o=this._renderer.view.canvas;if(t===2&&(s=o.getContext("webgl2",r)),!s&&(s=o.getContext("webgl",r),!s))throw new Error("This browser does not support WebGL. Try using the canvas renderer");this.gl=s,this.initFromContext(this.gl)}getExtensions(){let{gl:t}=this,r={anisotropicFiltering:t.getExtension("EXT_texture_filter_anisotropic"),floatTextureLinear:t.getExtension("OES_texture_float_linear"),s3tc:t.getExtension("WEBGL_compressed_texture_s3tc"),s3tc_sRGB:t.getExtension("WEBGL_compressed_texture_s3tc_srgb"),etc:t.getExtension("WEBGL_compressed_texture_etc"),etc1:t.getExtension("WEBGL_compressed_texture_etc1"),pvrtc:t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),atc:t.getExtension("WEBGL_compressed_texture_atc"),astc:t.getExtension("WEBGL_compressed_texture_astc"),bptc:t.getExtension("EXT_texture_compression_bptc"),rgtc:t.getExtension("EXT_texture_compression_rgtc"),loseContext:t.getExtension("WEBGL_lose_context")};this.webGLVersion===1?this.extensions=v(l({},r),{drawBuffers:t.getExtension("WEBGL_draw_buffers"),depthTexture:t.getExtension("WEBGL_depth_texture"),vertexArrayObject:t.getExtension("OES_vertex_array_object")||t.getExtension("MOZ_OES_vertex_array_object")||t.getExtension("WEBKIT_OES_vertex_array_object"),uint32ElementIndex:t.getExtension("OES_element_index_uint"),floatTexture:t.getExtension("OES_texture_float"),floatTextureLinear:t.getExtension("OES_texture_float_linear"),textureHalfFloat:t.getExtension("OES_texture_half_float"),textureHalfFloatLinear:t.getExtension("OES_texture_half_float_linear"),vertexAttribDivisorANGLE:t.getExtension("ANGLE_instanced_arrays"),srgb:t.getExtension("EXT_sRGB")}):this.extensions=v(l({},r),{colorBufferFloat:t.getExtension("EXT_color_buffer_float")})}handleContextLost(t){t.preventDefault(),this._contextLossForced&&(this._contextLossForced=!1,setTimeout(()=>{this.gl.isContextLost()&&this.extensions.loseContext?.restoreContext()},0))}handleContextRestored(){this._renderer.runners.contextChange.emit(this.gl)}destroy(){let t=this._renderer.view.canvas;this._renderer=null,t.removeEventListener("webglcontextlost",this.handleContextLost),t.removeEventListener("webglcontextrestored",this.handleContextRestored),this.gl.useProgram(null),this.extensions.loseContext?.loseContext()}forceContextLoss(){this.extensions.loseContext?.loseContext(),this._contextLossForced=!0}validateContext(t){let r=t.getContextAttributes();r&&!r.stencil&&p("Provided WebGL context does not have a stencil buffer, masks may not render correctly");let s=this.supports,o=this.webGLVersion===2,i=this.extensions;s.uint32Indices=o||!!i.uint32ElementIndex,s.uniformBufferObject=o,s.vertexArrayObject=o||!!i.vertexArrayObject,s.srgbTextures=o||!!i.srgb,s.nonPowOf2wrapping=o,s.nonPowOf2mipmaps=o,s.msaa=o,s.uint32Indices||p("Provided WebGL context does not support 32 index buffer, large scenes may not render correctly")}};ft.extension={type:[m.WebGLSystem],name:"context"};ft.defaultOptions={context:null,premultipliedAlpha:!0,preserveDrawingBuffer:!1,powerPreference:void 0,preferWebGLVersion:2};var Ft=ft;var J=(e=>(e[e.RGBA=6408]="RGBA",e[e.RGB=6407]="RGB",e[e.RG=33319]="RG",e[e.RED=6403]="RED",e[e.RGBA_INTEGER=36249]="RGBA_INTEGER",e[e.RGB_INTEGER=36248]="RGB_INTEGER",e[e.RG_INTEGER=33320]="RG_INTEGER",e[e.RED_INTEGER=36244]="RED_INTEGER",e[e.ALPHA=6406]="ALPHA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",e[e.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e))(J||{}),mt=(e=>(e[e.TEXTURE_2D=3553]="TEXTURE_2D",e[e.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",e[e.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",e[e.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",e[e.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",e[e.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",e[e.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",e))(mt||{});var _=(e=>(e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",e[e.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",e[e.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",e[e.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",e[e.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",e[e.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",e[e.BYTE=5120]="BYTE",e[e.SHORT=5122]="SHORT",e[e.INT=5124]="INT",e[e.FLOAT=5126]="FLOAT",e[e.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",e[e.HALF_FLOAT=36193]="HALF_FLOAT",e))(_||{});var Mt={uint8x2:_.UNSIGNED_BYTE,uint8x4:_.UNSIGNED_BYTE,sint8x2:_.BYTE,sint8x4:_.BYTE,unorm8x2:_.UNSIGNED_BYTE,unorm8x4:_.UNSIGNED_BYTE,snorm8x2:_.BYTE,snorm8x4:_.BYTE,uint16x2:_.UNSIGNED_SHORT,uint16x4:_.UNSIGNED_SHORT,sint16x2:_.SHORT,sint16x4:_.SHORT,unorm16x2:_.UNSIGNED_SHORT,unorm16x4:_.UNSIGNED_SHORT,snorm16x2:_.SHORT,snorm16x4:_.SHORT,float16x2:_.HALF_FLOAT,float16x4:_.HALF_FLOAT,float32:_.FLOAT,float32x2:_.FLOAT,float32x3:_.FLOAT,float32x4:_.FLOAT,uint32:_.UNSIGNED_INT,uint32x2:_.UNSIGNED_INT,uint32x3:_.UNSIGNED_INT,uint32x4:_.UNSIGNED_INT,sint32:_.INT,sint32x2:_.INT,sint32x3:_.INT,sint32x4:_.INT};function Lt(e){return Mt[e]??Mt.float32}var Se={"point-list":0,"line-list":1,"line-strip":3,"triangle-list":4,"triangle-strip":5},C=class{constructor(t){this._geometryVaoHash=Object.create(null),this._renderer=t,this._activeGeometry=null,this._activeVao=null,this.hasVao=!0,this.hasInstance=!0}contextChange(){let t=this.gl=this._renderer.gl;if(!this._renderer.context.supports.vertexArrayObject)throw new Error("[PixiJS] Vertex Array Objects are not supported on this device");let r=this._renderer.context.extensions.vertexArrayObject;r&&(t.createVertexArray=()=>r.createVertexArrayOES(),t.bindVertexArray=o=>r.bindVertexArrayOES(o),t.deleteVertexArray=o=>r.deleteVertexArrayOES(o));let s=this._renderer.context.extensions.vertexAttribDivisorANGLE;s&&(t.drawArraysInstanced=(o,i,n,a)=>{s.drawArraysInstancedANGLE(o,i,n,a)},t.drawElementsInstanced=(o,i,n,a,c)=>{s.drawElementsInstancedANGLE(o,i,n,a,c)},t.vertexAttribDivisor=(o,i)=>s.vertexAttribDivisorANGLE(o,i)),this._activeGeometry=null,this._activeVao=null,this._geometryVaoHash=Object.create(null)}bind(t,r){let s=this.gl;this._activeGeometry=t;let o=this.getVao(t,r);this._activeVao!==o&&(this._activeVao=o,s.bindVertexArray(o)),this.updateBuffers()}reset(){this.unbind()}updateBuffers(){let t=this._activeGeometry,r=this._renderer.buffer;for(let s=0;s<t.buffers.length;s++){let o=t.buffers[s];r.updateBuffer(o)}}checkCompatibility(t,r){let s=t.attributes,o=r._attributeData;for(let i in o)if(!s[i])throw new Error(`shader and geometry incompatible, geometry missing the "${i}" attribute`)}getSignature(t,r){let s=t.attributes,o=r._attributeData,i=["g",t.uid];for(let n in s)o[n]&&i.push(n,o[n].location);return i.join("-")}getVao(t,r){return this._geometryVaoHash[t.uid]?.[r._key]||this.initGeometryVao(t,r)}initGeometryVao(t,r,s=!0){let o=this._renderer.gl,i=this._renderer.buffer;this._renderer.shader._getProgramData(r),this.checkCompatibility(t,r);let n=this.getSignature(t,r);this._geometryVaoHash[t.uid]||(this._geometryVaoHash[t.uid]=Object.create(null),t.on("destroy",this.onGeometryDestroy,this));let a=this._geometryVaoHash[t.uid],c=a[n];if(c)return a[r._key]=c,c;Ut(t,r._attributeData);let u=t.buffers;c=o.createVertexArray(),o.bindVertexArray(c);for(let f=0;f<u.length;f++){let h=u[f];i.bind(h)}return this.activateVao(t,r),a[r._key]=c,a[n]=c,o.bindVertexArray(null),c}onGeometryDestroy(t,r){let s=this._geometryVaoHash[t.uid],o=this.gl;if(s){if(r)for(let i in s)this._activeVao!==s[i]&&this.unbind(),o.deleteVertexArray(s[i]);this._geometryVaoHash[t.uid]=null}}destroyAll(t=!1){let r=this.gl;for(let s in this._geometryVaoHash){if(t)for(let o in this._geometryVaoHash[s]){let i=this._geometryVaoHash[s];this._activeVao!==i&&this.unbind(),r.deleteVertexArray(i[o])}this._geometryVaoHash[s]=null}}activateVao(t,r){let s=this._renderer.gl,o=this._renderer.buffer,i=t.attributes;t.indexBuffer&&o.bind(t.indexBuffer);let n=null;for(let a in i){let c=i[a],u=c.buffer,f=o.getGlBuffer(u);if(r._attributeData[a]){n!==f&&(o.bind(u),n=f);let h=c.location;s.enableVertexAttribArray(h);let d=W(c.format);if(s.vertexAttribPointer(h,d.size,Lt(c.format),d.normalised,c.stride,c.offset),c.instance)if(this.hasInstance)s.vertexAttribDivisor(h,1);else throw new Error("geometry error, GPU Instancing is not supported on this device")}}}draw(t,r,s,o){let{gl:i}=this._renderer,n=this._activeGeometry,a=Se[n.topology||t];if(o||(o=n.instanceCount),n.indexBuffer){let c=n.indexBuffer.data.BYTES_PER_ELEMENT,u=c===2?i.UNSIGNED_SHORT:i.UNSIGNED_INT;o>1?i.drawElementsInstanced(a,r||n.indexBuffer.data.length,u,(s||0)*c,o):i.drawElements(a,r||n.indexBuffer.data.length,u,(s||0)*c)}else o>1?i.drawArraysInstanced(a,s||0,r||n.getSize(),o):i.drawArrays(a,s||0,r||n.getSize());return this}unbind(){this.gl.bindVertexArray(null),this._activeVao=null,this._activeGeometry=null}destroy(){this._renderer=null,this.gl=null,this._activeVao=null,this._activeGeometry=null}};C.extension={type:[m.WebGLSystem],name:"geometry"};var ge=new Rt({attributes:{aPosition:[-1,-1,3,-1,-1,3]}}),_t=class Ht{constructor(t){this.useBackBuffer=!1,this._useBackBufferThisRender=!1,this._renderer=t}init(t={}){let{useBackBuffer:r,antialias:s}=l(l({},Ht.defaultOptions),t);this.useBackBuffer=r,this._antialias=s,this._renderer.context.supports.msaa||(p("antialiasing, is not supported on when using the back buffer"),this._antialias=!1),this._state=g.for2d();let o=new xt({vertex:`
                attribute vec2 aPosition;
                out vec2 vUv;

                void main() {
                    gl_Position = vec4(aPosition, 0.0, 1.0);

                    vUv = (aPosition + 1.0) / 2.0;

                    // flip dem UVs
                    vUv.y = 1.0 - vUv.y;
                }`,fragment:`
                in vec2 vUv;
                out vec4 finalColor;

                uniform sampler2D uTexture;

                void main() {
                    finalColor = texture(uTexture, vUv);
                }`,name:"big-triangle"});this._bigTriangleShader=new b({glProgram:o,resources:{uTexture:E.WHITE.source}})}renderStart(t){let r=this._renderer.renderTarget.getRenderTarget(t.target);if(this._useBackBufferThisRender=this.useBackBuffer&&!!r.isRoot,this._useBackBufferThisRender){let s=this._renderer.renderTarget.getRenderTarget(t.target);this._targetTexture=s.colorTexture,t.target=this._getBackBufferTexture(s.colorTexture)}}renderEnd(){this._presentBackBuffer()}_presentBackBuffer(){let t=this._renderer;t.renderTarget.finishRenderPass(),this._useBackBufferThisRender&&(t.renderTarget.bind(this._targetTexture,!1),this._bigTriangleShader.resources.uTexture=this._backBufferTexture.source,t.encoder.draw({geometry:ge,shader:this._bigTriangleShader,state:this._state}))}_getBackBufferTexture(t){return this._backBufferTexture=this._backBufferTexture||new E({source:new V({width:t.width,height:t.height,resolution:t._resolution,antialias:this._antialias})}),this._backBufferTexture.source.resize(t.width,t.height,t._resolution),this._backBufferTexture}destroy(){this._backBufferTexture&&(this._backBufferTexture.destroy(),this._backBufferTexture=null)}};_t.extension={type:[m.WebGLSystem],name:"backBuffer",priority:1};_t.defaultOptions={useBackBuffer:!1};var wt=_t;var U=class{constructor(t){this._colorMaskCache=15,this._renderer=t}setMask(t){this._colorMaskCache!==t&&(this._colorMaskCache=t,this._renderer.gl.colorMask(!!(t&8),!!(t&4),!!(t&2),!!(t&1)))}};U.extension={type:[m.WebGLSystem],name:"colorMask"};var G=class{constructor(t){this.commandFinished=Promise.resolve(),this._renderer=t}setGeometry(t,r){this._renderer.geometry.bind(t,r.glProgram)}finishRenderPass(){}draw(t){let r=this._renderer,{geometry:s,shader:o,state:i,skipSync:n,topology:a,size:c,start:u,instanceCount:f}=t;r.shader.bind(o,n),r.geometry.bind(s,r.shader._activeProgram),i&&r.state.set(i),r.geometry.draw(a,c,u,f??s.instanceCount)}destroy(){this._renderer=null}};G.extension={type:[m.WebGLSystem],name:"encoder"};var P=class{constructor(t){this._stencilCache={enabled:!1,stencilReference:0,stencilMode:X.NONE},this._renderTargetStencilState=Object.create(null),t.renderTarget.onRenderTargetChange.add(this)}contextChange(t){this._gl=t,this._comparisonFuncMapping={always:t.ALWAYS,never:t.NEVER,equal:t.EQUAL,"not-equal":t.NOTEQUAL,less:t.LESS,"less-equal":t.LEQUAL,greater:t.GREATER,"greater-equal":t.GEQUAL},this._stencilOpsMapping={keep:t.KEEP,zero:t.ZERO,replace:t.REPLACE,invert:t.INVERT,"increment-clamp":t.INCR,"decrement-clamp":t.DECR,"increment-wrap":t.INCR_WRAP,"decrement-wrap":t.DECR_WRAP}}onRenderTargetChange(t){if(this._activeRenderTarget===t)return;this._activeRenderTarget=t;let r=this._renderTargetStencilState[t.uid];r||(r=this._renderTargetStencilState[t.uid]={stencilMode:X.DISABLED,stencilReference:0}),this.setStencilMode(r.stencilMode,r.stencilReference)}setStencilMode(t,r){let s=this._renderTargetStencilState[this._activeRenderTarget.uid],o=this._gl,i=Gt[t],n=this._stencilCache;if(s.stencilMode=t,s.stencilReference=r,t===X.DISABLED){this._stencilCache.enabled&&(this._stencilCache.enabled=!1,o.disable(o.STENCIL_TEST));return}this._stencilCache.enabled||(this._stencilCache.enabled=!0,o.enable(o.STENCIL_TEST)),(t!==n.stencilMode||n.stencilReference!==r)&&(n.stencilMode=t,n.stencilReference=r,o.stencilFunc(this._comparisonFuncMapping[i.stencilBack.compare],r,255),o.stencilOp(o.KEEP,o.KEEP,this._stencilOpsMapping[i.stencilBack.passOp]))}};P.extension={type:[m.WebGLSystem],name:"stencil"};var ht={f32:4,"vec2<f32>":8,"vec3<f32>":12,"vec4<f32>":16,"mat2x2<f32>":32,"mat3x3<f32>":48,"mat4x4<f32>":64};function Vt(e){let t=e.map(i=>({data:i,offset:0,size:0})),r=0,s=0,o=0;for(let i=0;i<t.length;i++){let n=t[i];if(r=ht[n.data.type],!r)throw new Error(`Unknown type ${n.data.type}`);if(n.data.size>1&&(r=Math.max(r,16)*n.data.size),n.size=r,s%r!==0&&s<16){let a=s%r%16;s+=a,o+=a}s+r>16?(o=Math.ceil(o/16)*16,n.offset=o,o+=r,s=r):(n.offset=o,s+=r,o+=r)}return o=Math.ceil(o/16)*16,{uboElements:t,size:o}}function kt(e,t){let r=Math.max(ht[e.data.type]/16,1),s=e.data.value.length/e.data.size,o=(4-s%4)%4;return`
        v = uv.${e.data.name};
        offset += ${t};

        arrayOffset = offset;

        t = 0;

        for(var i=0; i < ${e.data.size*r}; i++)
        {
            for(var j = 0; j < ${s}; j++)
            {
                data[arrayOffset++] = v[t++];
            }
            ${o!==0?`arrayOffset += ${o};`:""}
        }
    `}function Xt(e){return Dt(e,"uboStd40",kt,Ct)}var O=class extends It{constructor(){super({createUboElements:Vt,generateUboSync:Xt})}};O.extension={type:[m.WebGLSystem],name:"ubo"};var tt=class{constructor(){this.width=-1,this.height=-1,this.msaa=!1,this.msaaRenderBuffer=[]}};var et=class{constructor(){this._clearColorCache=[0,0,0,0],this._viewPortCache=new ut}init(t,r){this._renderer=t,this._renderTargetSystem=r,t.runners.contextChange.add(this)}contextChange(){this._clearColorCache=[0,0,0,0],this._viewPortCache=new ut}copyToTexture(t,r,s,o,i){let n=this._renderTargetSystem,a=this._renderer,c=n.getGpuRenderTarget(t),u=a.gl;return this.finishRenderPass(t),u.bindFramebuffer(u.FRAMEBUFFER,c.resolveTargetFramebuffer),a.texture.bind(r,0),u.copyTexSubImage2D(u.TEXTURE_2D,0,i.x,i.y,s.x,s.y,o.width,o.height),r}startRenderPass(t,r=!0,s,o){let i=this._renderTargetSystem,n=t.colorTexture,a=i.getGpuRenderTarget(t),c=o.y;t.isRoot&&(c=n.pixelHeight-o.height),t.colorTextures.forEach(h=>{this._renderer.texture.unbind(h)});let u=this._renderer.gl;u.bindFramebuffer(u.FRAMEBUFFER,a.framebuffer);let f=this._viewPortCache;(f.x!==o.x||f.y!==c||f.width!==o.width||f.height!==o.height)&&(f.x=o.x,f.y=c,f.width=o.width,f.height=o.height,u.viewport(o.x,c,o.width,o.height)),!a.depthStencilRenderBuffer&&(t.stencil||t.depth)&&this._initStencil(a),this.clear(t,r,s)}finishRenderPass(t){let s=this._renderTargetSystem.getGpuRenderTarget(t);if(!s.msaa)return;let o=this._renderer.gl;o.bindFramebuffer(o.FRAMEBUFFER,s.resolveTargetFramebuffer),o.bindFramebuffer(o.READ_FRAMEBUFFER,s.framebuffer),o.blitFramebuffer(0,0,s.width,s.height,0,0,s.width,s.height,o.COLOR_BUFFER_BIT,o.NEAREST),o.bindFramebuffer(o.FRAMEBUFFER,s.framebuffer)}initGpuRenderTarget(t){let s=this._renderer.gl,o=new tt;return Tt.test(t.colorTexture.resource)?(o.framebuffer=null,o):(this._initColor(t,o),s.bindFramebuffer(s.FRAMEBUFFER,null),o)}clear(t,r,s){if(!r)return;let o=this._renderTargetSystem;typeof r=="boolean"&&(r=r?z.ALL:z.NONE);let i=this._renderer.gl;if(r&z.COLOR){s??(s=o.defaultClearColor);let n=this._clearColorCache,a=s;(n[0]!==a[0]||n[1]!==a[1]||n[2]!==a[2]||n[3]!==a[3])&&(n[0]=a[0],n[1]=a[1],n[2]=a[2],n[3]=a[3],i.clearColor(a[0],a[1],a[2],a[3]))}i.clear(r)}resizeGpuRenderTarget(t){if(t.isRoot)return;let s=this._renderTargetSystem.getGpuRenderTarget(t);this._resizeColor(t,s),t.stencil&&this._resizeStencil(s)}_initColor(t,r){let s=this._renderer,o=s.gl,i=o.createFramebuffer();if(r.resolveTargetFramebuffer=i,o.bindFramebuffer(o.FRAMEBUFFER,i),r.width=t.colorTexture.source.pixelWidth,r.height=t.colorTexture.source.pixelHeight,t.colorTextures.forEach((n,a)=>{let c=n.source;c.antialias&&(s.context.supports.msaa?r.msaa=!0:p("[RenderTexture] Antialiasing on textures is not supported in WebGL1")),s.texture.bindSource(c,0);let f=s.texture.getGlSource(c).texture;o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0+a,3553,f,0)}),r.msaa){let n=o.createFramebuffer();r.framebuffer=n,o.bindFramebuffer(o.FRAMEBUFFER,n),t.colorTextures.forEach((a,c)=>{let u=o.createRenderbuffer();r.msaaRenderBuffer[c]=u})}else r.framebuffer=i;this._resizeColor(t,r)}_resizeColor(t,r){let s=t.colorTexture.source;if(r.width=s.pixelWidth,r.height=s.pixelHeight,t.colorTextures.forEach((o,i)=>{i!==0&&o.source.resize(s.width,s.height,s._resolution)}),r.msaa){let o=this._renderer,i=o.gl,n=r.framebuffer;i.bindFramebuffer(i.FRAMEBUFFER,n),t.colorTextures.forEach((a,c)=>{let u=a.source;o.texture.bindSource(u,0);let h=o.texture.getGlSource(u).internalFormat,d=r.msaaRenderBuffer[c];i.bindRenderbuffer(i.RENDERBUFFER,d),i.renderbufferStorageMultisample(i.RENDERBUFFER,4,h,u.pixelWidth,u.pixelHeight),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+c,i.RENDERBUFFER,d)})}}_initStencil(t){if(t.framebuffer===null)return;let r=this._renderer.gl,s=r.createRenderbuffer();t.depthStencilRenderBuffer=s,r.bindRenderbuffer(r.RENDERBUFFER,s),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,s),this._resizeStencil(t)}_resizeStencil(t){let r=this._renderer.gl;r.bindRenderbuffer(r.RENDERBUFFER,t.depthStencilRenderBuffer),t.msaa?r.renderbufferStorageMultisample(r.RENDERBUFFER,4,r.DEPTH24_STENCIL8,t.width,t.height):r.renderbufferStorage(r.RENDERBUFFER,this._renderer.context.webGLVersion===2?r.DEPTH24_STENCIL8:r.DEPTH_STENCIL,t.width,t.height)}};var F=class extends Pt{constructor(t){super(t),this.adaptor=new et,this.adaptor.init(t,this)}};F.extension={type:[m.WebGLSystem],name:"renderTarget"};function Wt(e,t){let r=[],s=[`
        var g = s.groups;
        var sS = r.shader;
        var p = s.glProgram;
        var ugS = r.uniformGroup;
        var resources;
    `],o=!1,i=0,n=0,a=t._getProgramData(e.glProgram);for(let u in e.groups){let f=e.groups[u];r.push(`
            resources = g[${u}].resources;
        `);for(let h in f.resources){let d=f.resources[h];if(d instanceof T)d.ubo?r.push(`
                        sS.bindUniformBlock(
                            resources[${h}],
                            sS._uniformBindMap[${u}[${h}],
                            ${i++}
                        );
                    `):r.push(`
                        ugS.updateUniformGroup(resources[${h}], p, sD);
                    `);else if(d instanceof Z)r.push(`
                    sS.bindUniformBlock(
                        resources[${h}],
                        sS._uniformBindMap[${u}[${h}],
                        ${i++}
                    );
                `);else if(d instanceof V){let Ee=e._uniformBindMap[u][h],gt=a.uniformData[Ee];gt&&(o||(o=!0,s.push(`
                        var tS = r.texture;
                        `)),t._gl.uniform1i(gt.location,n),r.push(`
                        tS.bind(resources[${h}], ${n});
                    `),n++)}}}let c=[...s,...r].join(`
`);return new Function("r","s","sD",c)}var rt=class{constructor(t,r){this.program=t,this.uniformData=r,this.uniformGroups={},this.uniformDirtyGroups={},this.uniformBlockBindings={}}destroy(){this.uniformData=null,this.uniformGroups=null,this.uniformDirtyGroups=null,this.uniformBlockBindings=null,this.program=null}};function lt(e,t,r){let s=e.createShader(t);return e.shaderSource(s,r),e.compileShader(s),s}function dt(e){let t=new Array(e);for(let r=0;r<t.length;r++)t[r]=!1;return t}function st(e,t){switch(e){case"float":return 0;case"vec2":return new Float32Array(2*t);case"vec3":return new Float32Array(3*t);case"vec4":return new Float32Array(4*t);case"int":case"uint":case"sampler2D":case"sampler2DArray":return 0;case"ivec2":return new Int32Array(2*t);case"ivec3":return new Int32Array(3*t);case"ivec4":return new Int32Array(4*t);case"uvec2":return new Uint32Array(2*t);case"uvec3":return new Uint32Array(3*t);case"uvec4":return new Uint32Array(4*t);case"bool":return!1;case"bvec2":return dt(2*t);case"bvec3":return dt(3*t);case"bvec4":return dt(4*t);case"mat2":return new Float32Array([1,0,0,1]);case"mat3":return new Float32Array([1,0,0,0,1,0,0,0,1]);case"mat4":return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return null}var ot=null,jt={FLOAT:"float",FLOAT_VEC2:"vec2",FLOAT_VEC3:"vec3",FLOAT_VEC4:"vec4",INT:"int",INT_VEC2:"ivec2",INT_VEC3:"ivec3",INT_VEC4:"ivec4",UNSIGNED_INT:"uint",UNSIGNED_INT_VEC2:"uvec2",UNSIGNED_INT_VEC3:"uvec3",UNSIGNED_INT_VEC4:"uvec4",BOOL:"bool",BOOL_VEC2:"bvec2",BOOL_VEC3:"bvec3",BOOL_VEC4:"bvec4",FLOAT_MAT2:"mat2",FLOAT_MAT3:"mat3",FLOAT_MAT4:"mat4",SAMPLER_2D:"sampler2D",INT_SAMPLER_2D:"sampler2D",UNSIGNED_INT_SAMPLER_2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT_SAMPLER_CUBE:"samplerCube",UNSIGNED_INT_SAMPLER_CUBE:"samplerCube",SAMPLER_2D_ARRAY:"sampler2DArray",INT_SAMPLER_2D_ARRAY:"sampler2DArray",UNSIGNED_INT_SAMPLER_2D_ARRAY:"sampler2DArray"},Te={float:"float32",vec2:"float32x2",vec3:"float32x3",vec4:"float32x4",int:"sint32",ivec2:"sint32x2",ivec3:"sint32x3",ivec4:"sint32x4",uint:"uint32",uvec2:"uint32x2",uvec3:"uint32x3",uvec4:"uint32x4",bool:"uint32",bvec2:"uint32x2",bvec3:"uint32x3",bvec4:"uint32x4"};function pt(e,t){if(!ot){let r=Object.keys(jt);ot={};for(let s=0;s<r.length;++s){let o=r[s];ot[e[o]]=jt[o]}}return ot[t]}function Kt(e,t){let r=pt(e,t);return Te[r]||"float32"}function $t(e,t,r=!1){let s={},o=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let n=0;n<o;n++){let a=t.getActiveAttrib(e,n);if(a.name.startsWith("gl_"))continue;let c=Kt(t,a.type);s[a.name]={location:0,format:c,stride:W(c).stride,offset:0,instance:!1,start:0}}let i=Object.keys(s);if(r){i.sort((n,a)=>n>a?1:-1);for(let n=0;n<i.length;n++)s[i[n]].location=n,t.bindAttribLocation(e,n,i[n]);t.linkProgram(e)}else for(let n=0;n<i.length;n++)s[i[n]].location=t.getAttribLocation(e,i[n]);return s}function Yt(e,t){if(!t.ACTIVE_UNIFORM_BLOCKS)return{};let r={},s=t.getProgramParameter(e,t.ACTIVE_UNIFORM_BLOCKS);for(let o=0;o<s;o++){let i=t.getActiveUniformBlockName(e,o),n=t.getUniformBlockIndex(e,i),a=t.getActiveUniformBlockParameter(e,o,t.UNIFORM_BLOCK_DATA_SIZE);r[i]={name:i,index:n,size:a}}return r}function zt(e,t){let r={},s=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let o=0;o<s;o++){let i=t.getActiveUniform(e,o),n=i.name.replace(/\[.*?\]$/,""),a=!!i.name.match(/\[.*?\]$/),c=pt(t,i.type);r[n]={name:n,index:o,type:c,size:i.size,isArray:a,value:st(c,i.size)}}return r}function qt(e,t){let r=e.getShaderSource(t).split(`
`).map((u,f)=>`${f}: ${u}`),s=e.getShaderInfoLog(t),o=s.split(`
`),i={},n=o.map(u=>parseFloat(u.replace(/^ERROR\: 0\:([\d]+)\:.*$/,"$1"))).filter(u=>u&&!i[u]?(i[u]=!0,!0):!1),a=[""];n.forEach(u=>{r[u-1]=`%c${r[u-1]}%c`,a.push("background: #FF0000; color:#FFFFFF; font-size: 10px","font-size: 10px")});let c=r.join(`
`);a[0]=c,console.error(s),console.groupCollapsed("click to view full shader code"),console.warn(...a),console.groupEnd()}function Zt(e,t,r,s){e.getProgramParameter(t,e.LINK_STATUS)||(e.getShaderParameter(r,e.COMPILE_STATUS)||qt(e,r),e.getShaderParameter(s,e.COMPILE_STATUS)||qt(e,s),console.error("PixiJS Error: Could not initialize shader."),e.getProgramInfoLog(t)!==""&&console.warn("PixiJS Warning: gl.getProgramInfoLog()",e.getProgramInfoLog(t)))}function Qt(e,t){let r=lt(e,e.VERTEX_SHADER,t.vertex),s=lt(e,e.FRAGMENT_SHADER,t.fragment),o=e.createProgram();e.attachShader(o,r),e.attachShader(o,s);let i=t.transformFeedbackVaryings;i&&(typeof e.transformFeedbackVaryings!="function"?p("TransformFeedback is not supported but TransformFeedbackVaryings are given."):e.transformFeedbackVaryings(o,i.names,i.bufferMode==="separate"?e.SEPARATE_ATTRIBS:e.INTERLEAVED_ATTRIBS)),e.linkProgram(o),e.getProgramParameter(o,e.LINK_STATUS)||Zt(e,o,r,s),t._attributeData=$t(o,e,!/^[ \t]*#[ \t]*version[ \t]+300[ \t]+es[ \t]*$/m.test(t.vertex)),t._uniformData=zt(o,e),t._uniformBlockData=Yt(o,e),e.deleteShader(r),e.deleteShader(s);let n={};for(let c in t._uniformData){let u=t._uniformData[c];n[c]={location:e.getUniformLocation(o,c),value:st(u.type,u.size)}}return new rt(o,n)}var it={textureCount:0,blockIndex:0},M=class{constructor(t){this._activeProgram=null,this._programDataHash=Object.create(null),this._nextIndex=0,this._boundUniformsIdsToIndexHash=Object.create(null),this._boundIndexToUniformsHash=Object.create(null),this._shaderSyncFunctions=Object.create(null),this._renderer=t}contextChange(t){this._gl=t,this._maxBindings=t.MAX_UNIFORM_BUFFER_BINDINGS?t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS):0,this._programDataHash=Object.create(null),this._boundUniformsIdsToIndexHash=Object.create(null),this._boundIndexToUniformsHash=Object.create(null),this._activeProgram=null}bind(t,r){if(this._setProgram(t.glProgram),r)return;it.textureCount=0,it.blockIndex=0;let s=this._shaderSyncFunctions[t.glProgram._key];s||(s=this._shaderSyncFunctions[t.glProgram._key]=this._generateShaderSync(t,this)),s(this._renderer,t,it)}updateUniformGroup(t){this._renderer.uniformGroup.updateUniformGroup(t,this._activeProgram,it)}bindUniformBlock(t,r,s=0){let o=this._renderer.buffer,i=this._getProgramData(this._activeProgram),n=t._bufferResource;n&&this._renderer.ubo.updateUniformGroup(t),o.updateBuffer(t.buffer);let a=this._boundUniformsIdsToIndexHash[t.uid];if(a===void 0){let f=this._nextIndex++%this._maxBindings,h=this._boundIndexToUniformsHash[f];h&&(this._boundUniformsIdsToIndexHash[h.uid]=void 0),a=this._boundUniformsIdsToIndexHash[t.uid]=f,this._boundIndexToUniformsHash[f]=t,n?o.bindBufferRange(t.buffer,f,t.offset):o.bindBufferBase(t.buffer,f)}let c=this._gl,u=this._activeProgram._uniformBlockData[r].index;i.uniformBlockBindings[s]!==a&&(i.uniformBlockBindings[s]=a,c.uniformBlockBinding(i.program,u,a))}_setProgram(t){if(this._activeProgram===t)return;this._activeProgram=t;let r=this._getProgramData(t);this._gl.useProgram(r.program)}_getProgramData(t){return this._programDataHash[t._key]||this._createProgramData(t)}_createProgramData(t){let r=t._key;return this._programDataHash[r]=Qt(this._gl,t),this._programDataHash[r]}destroy(){for(let t of Object.keys(this._programDataHash))this._programDataHash[t].destroy(),this._programDataHash[t]=null;this._programDataHash=null,this._boundUniformsIdsToIndexHash=null}_generateShaderSync(t,r){return Wt(t,r)}};M.extension={type:[m.WebGLSystem],name:"shader"};var Jt={f32:`if (cv !== v) {
            cu.value = v;
            gl.uniform1f(location, v);
        }`,"vec2<f32>":`if (cv[0] !== v[0] || cv[1] !== v[1]) {
            cv[0] = v[0];
            cv[1] = v[1];
            gl.uniform2f(location, v[0], v[1]);
        }`,"vec3<f32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            gl.uniform3f(location, v[0], v[1], v[2]);
        }`,"vec4<f32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            cv[3] = v[3];
            gl.uniform4f(location, v[0], v[1], v[2], v[3]);
        }`,i32:`if (cv !== v) {
            cu.value = v;
            gl.uniform1i(location, v);
        }`,"vec2<i32>":`if (cv[0] !== v[0] || cv[1] !== v[1]) {
            cv[0] = v[0];
            cv[1] = v[1];
            gl.uniform2i(location, v[0], v[1]);
        }`,"vec3<i32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            gl.uniform3i(location, v[0], v[1], v[2]);
        }`,"vec4<i32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            cv[3] = v[3];
            gl.uniform4i(location, v[0], v[1], v[2], v[3]);
        }`,u32:`if (cv !== v) {
            cu.value = v;
            gl.uniform1ui(location, v);
        }`,"vec2<u32>":`if (cv[0] !== v[0] || cv[1] !== v[1]) {
            cv[0] = v[0];
            cv[1] = v[1];
            gl.uniform2ui(location, v[0], v[1]);
        }`,"vec3<u32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            gl.uniform3ui(location, v[0], v[1], v[2]);
        }`,"vec4<u32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            cv[3] = v[3];
            gl.uniform4ui(location, v[0], v[1], v[2], v[3]);
        }`,bool:`if (cv !== v) {
            cu.value = v;
            gl.uniform1i(location, v);
        }`,"vec2<bool>":`if (cv[0] !== v[0] || cv[1] !== v[1]) {
            cv[0] = v[0];
            cv[1] = v[1];
            gl.uniform2i(location, v[0], v[1]);
        }`,"vec3<bool>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            gl.uniform3i(location, v[0], v[1], v[2]);
        }`,"vec4<bool>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            cv[3] = v[3];
            gl.uniform4i(location, v[0], v[1], v[2], v[3]);
        }`,"mat2x2<f32>":"gl.uniformMatrix2fv(location, false, v);","mat3x3<f32>":"gl.uniformMatrix3fv(location, false, v);","mat4x4<f32>":"gl.uniformMatrix4fv(location, false, v);"},te={f32:"gl.uniform1fv(location, v);","vec2<f32>":"gl.uniform2fv(location, v);","vec3<f32>":"gl.uniform3fv(location, v);","vec4<f32>":"gl.uniform4fv(location, v);","mat2x2<f32>":"gl.uniformMatrix2fv(location, false, v);","mat3x3<f32>":"gl.uniformMatrix3fv(location, false, v);","mat4x4<f32>":"gl.uniformMatrix4fv(location, false, v);",i32:"gl.uniform1iv(location, v);","vec2<i32>":"gl.uniform2iv(location, v);","vec3<i32>":"gl.uniform3iv(location, v);","vec4<i32>":"gl.uniform4iv(location, v);",u32:"gl.uniform1iv(location, v);","vec2<u32>":"gl.uniform2iv(location, v);","vec3<u32>":"gl.uniform3iv(location, v);","vec4<u32>":"gl.uniform4iv(location, v);",bool:"gl.uniform1iv(location, v);","vec2<bool>":"gl.uniform2iv(location, v);","vec3<bool>":"gl.uniform3iv(location, v);","vec4<bool>":"gl.uniform4iv(location, v);"};function ee(e,t){let r=[`
        var v = null;
        var cv = null;
        var cu = null;
        var t = 0;
        var gl = renderer.gl;
        var name = null;
    `];for(let s in e.uniforms){if(!t[s]){e.uniforms[s]instanceof T?e.uniforms[s].ubo?r.push(`
                        renderer.shader.bindUniformBlock(uv.${s}, "${s}");
                    `):r.push(`
                        renderer.shader.updateUniformGroup(uv.${s});
                    `):e.uniforms[s]instanceof Z&&r.push(`
                        renderer.shader.bindBufferResource(uv.${s}, "${s}");
                    `);continue}let o=e.uniformStructures[s],i=!1;for(let n=0;n<q.length;n++){let a=q[n];if(o.type===a.type&&a.test(o)){r.push(`name = "${s}";`,q[n].uniform),i=!0;break}}if(!i){let a=(o.size===1?Jt:te)[o.type].replace("location",`ud["${s}"].location`);r.push(`
            cu = ud["${s}"];
            cv = cu.value;
            v = uv["${s}"];
            ${a};`)}}return new Function("ud","uv","renderer","syncData",r.join(`
`))}var L=class{constructor(t){this._cache={},this._uniformGroupSyncHash={},this._renderer=t,this.gl=null,this._cache={}}contextChange(t){this.gl=t}updateUniformGroup(t,r,s){let o=this._renderer.shader._getProgramData(r);(!t.isStatic||t._dirtyId!==o.uniformDirtyGroups[t.uid])&&(o.uniformDirtyGroups[t.uid]=t._dirtyId,this._getUniformSyncFunction(t,r)(o.uniformData,t.uniforms,this._renderer,s))}_getUniformSyncFunction(t,r){return this._uniformGroupSyncHash[t._signature]?.[r._key]||this._createUniformSyncFunction(t,r)}_createUniformSyncFunction(t,r){let s=this._uniformGroupSyncHash[t._signature]||(this._uniformGroupSyncHash[t._signature]={}),o=this._getSignature(t,r._uniformData,"u");return this._cache[o]||(this._cache[o]=this._generateUniformsSync(t,r._uniformData)),s[r._key]=this._cache[o],s[r._key]}_generateUniformsSync(t,r){return ee(t,r)}_getSignature(t,r,s){let o=t.uniforms,i=[`${s}-`];for(let n in o)i.push(n),r[n]&&i.push(r[n].type);return i.join("-")}destroy(){this._renderer=null,this._cache=null}};L.extension={type:[m.WebGLSystem],name:"uniformGroup"};function re(e){let t={};return t.normal=[e.ONE,e.ONE_MINUS_SRC_ALPHA],t.add=[e.ONE,e.ONE],t.multiply=[e.DST_COLOR,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA],t.screen=[e.ONE,e.ONE_MINUS_SRC_COLOR,e.ONE,e.ONE_MINUS_SRC_ALPHA],t.none=[0,0],t["normal-npm"]=[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA],t["add-npm"]=[e.SRC_ALPHA,e.ONE,e.ONE,e.ONE],t["screen-npm"]=[e.SRC_ALPHA,e.ONE_MINUS_SRC_COLOR,e.ONE,e.ONE_MINUS_SRC_ALPHA],t.erase=[e.ZERO,e.ONE_MINUS_SRC_ALPHA],t}var Re=0,xe=1,ve=2,Ae=3,Be=4,Ne=5,se=class Et{constructor(){this.gl=null,this.stateId=0,this.polygonOffset=0,this.blendMode="none",this._blendEq=!1,this.map=[],this.map[Re]=this.setBlend,this.map[xe]=this.setOffset,this.map[ve]=this.setCullFace,this.map[Ae]=this.setDepthTest,this.map[Be]=this.setFrontFace,this.map[Ne]=this.setDepthMask,this.checks=[],this.defaultState=g.for2d()}contextChange(t){this.gl=t,this.blendModesMap=re(t),this.reset()}set(t){if(t=t||this.defaultState,this.stateId!==t.data){let r=this.stateId^t.data,s=0;for(;r;)r&1&&this.map[s].call(this,!!(t.data&1<<s)),r=r>>1,s++;this.stateId=t.data}for(let r=0;r<this.checks.length;r++)this.checks[r](this,t)}forceState(t){t=t||this.defaultState;for(let r=0;r<this.map.length;r++)this.map[r].call(this,!!(t.data&1<<r));for(let r=0;r<this.checks.length;r++)this.checks[r](this,t);this.stateId=t.data}setBlend(t){this._updateCheck(Et._checkBlendMode,t),this.gl[t?"enable":"disable"](this.gl.BLEND)}setOffset(t){this._updateCheck(Et._checkPolygonOffset,t),this.gl[t?"enable":"disable"](this.gl.POLYGON_OFFSET_FILL)}setDepthTest(t){this.gl[t?"enable":"disable"](this.gl.DEPTH_TEST)}setDepthMask(t){this.gl.depthMask(t)}setCullFace(t){this.gl[t?"enable":"disable"](this.gl.CULL_FACE)}setFrontFace(t){this.gl.frontFace(this.gl[t?"CW":"CCW"])}setBlendMode(t){if(this.blendModesMap[t]||(t="normal"),t===this.blendMode)return;this.blendMode=t;let r=this.blendModesMap[t],s=this.gl;r.length===2?s.blendFunc(r[0],r[1]):s.blendFuncSeparate(r[0],r[1],r[2],r[3]),r.length===6?(this._blendEq=!0,s.blendEquationSeparate(r[4],r[5])):this._blendEq&&(this._blendEq=!1,s.blendEquationSeparate(s.FUNC_ADD,s.FUNC_ADD))}setPolygonOffset(t,r){this.gl.polygonOffset(t,r)}reset(){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!1),this.forceState(this.defaultState),this._blendEq=!0,this.blendMode="",this.setBlendMode("normal")}_updateCheck(t,r){let s=this.checks.indexOf(t);r&&s===-1?this.checks.push(t):!r&&s!==-1&&this.checks.splice(s,1)}static _checkBlendMode(t,r){t.setBlendMode(r.blendMode)}static _checkPolygonOffset(t,r){t.setPolygonOffset(1,r.polygonOffset)}destroy(){this.gl=null,this.checks.length=0}};se.extension={type:[m.WebGLSystem],name:"state"};var oe=se;var nt=class{constructor(t){this.target=mt.TEXTURE_2D,this.texture=t,this.width=-1,this.height=-1,this.type=_.UNSIGNED_BYTE,this.internalFormat=J.RGBA,this.format=J.RGBA,this.samplerType=0}};var ie={id:"image",upload(e,t,r){t.width===e.width||t.height===e.height?r.texSubImage2D(r.TEXTURE_2D,0,0,0,t.format,t.type,e.resource):r.texImage2D(t.target,0,t.internalFormat,e.width,e.height,0,t.format,t.type,e.resource),t.width=e.width,t.height=e.height}};var ye={"bc1-rgba-unorm":!0,"bc1-rgba-unorm-srgb":!0,"bc2-rgba-unorm":!0,"bc2-rgba-unorm-srgb":!0,"bc3-rgba-unorm":!0,"bc3-rgba-unorm-srgb":!0,"bc4-r-unorm":!0,"bc4-r-snorm":!0,"bc5-rg-unorm":!0,"bc5-rg-snorm":!0,"bc6h-rgb-ufloat":!0,"bc6h-rgb-float":!0,"bc7-rgba-unorm":!0,"bc7-rgba-unorm-srgb":!0,"etc2-rgb8unorm":!0,"etc2-rgb8unorm-srgb":!0,"etc2-rgb8a1unorm":!0,"etc2-rgb8a1unorm-srgb":!0,"etc2-rgba8unorm":!0,"etc2-rgba8unorm-srgb":!0,"eac-r11unorm":!0,"eac-r11snorm":!0,"eac-rg11unorm":!0,"eac-rg11snorm":!0,"astc-4x4-unorm":!0,"astc-4x4-unorm-srgb":!0,"astc-5x4-unorm":!0,"astc-5x4-unorm-srgb":!0,"astc-5x5-unorm":!0,"astc-5x5-unorm-srgb":!0,"astc-6x5-unorm":!0,"astc-6x5-unorm-srgb":!0,"astc-6x6-unorm":!0,"astc-6x6-unorm-srgb":!0,"astc-8x5-unorm":!0,"astc-8x5-unorm-srgb":!0,"astc-8x6-unorm":!0,"astc-8x6-unorm-srgb":!0,"astc-8x8-unorm":!0,"astc-8x8-unorm-srgb":!0,"astc-10x5-unorm":!0,"astc-10x5-unorm-srgb":!0,"astc-10x6-unorm":!0,"astc-10x6-unorm-srgb":!0,"astc-10x8-unorm":!0,"astc-10x8-unorm-srgb":!0,"astc-10x10-unorm":!0,"astc-10x10-unorm-srgb":!0,"astc-12x10-unorm":!0,"astc-12x10-unorm-srgb":!0,"astc-12x12-unorm":!0,"astc-12x12-unorm-srgb":!0},ne={id:"compressed",upload(e,t,r){r.pixelStorei(r.UNPACK_ALIGNMENT,4);let s=e.pixelWidth,o=e.pixelHeight,i=!!ye[e.format];for(let n=0;n<e.resource.length;n++){let a=e.resource[n];i?r.compressedTexImage2D(r.TEXTURE_2D,n,t.internalFormat,s,o,0,a):r.texImage2D(r.TEXTURE_2D,n,t.internalFormat,s,o,0,t.format,t.type,a),s=Math.max(s>>1,1),o=Math.max(o>>1,1)}}};var at={id:"image",upload(e,t,r,s){let o=e.alphaMode==="premultiply-alpha-on-upload";r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o);let i=t.width,n=t.height,a=e.pixelWidth,c=e.pixelHeight,u=e.resourceWidth,f=e.resourceHeight;u<a||f<c?((i!==a||n!==c)&&r.texImage2D(t.target,0,t.internalFormat,a,c,0,t.format,t.type,null),s===2?r.texSubImage2D(r.TEXTURE_2D,0,0,0,u,f,t.format,t.type,e.resource):r.texSubImage2D(r.TEXTURE_2D,0,0,0,t.format,t.type,e.resource)):i===a||n===c?r.texSubImage2D(r.TEXTURE_2D,0,0,0,t.format,t.type,e.resource):s===2?r.texImage2D(t.target,0,t.internalFormat,a,c,0,t.format,t.type,e.resource):r.texImage2D(t.target,0,t.internalFormat,t.format,t.type,e.resource),t.width=a,t.height=c}};var ae={id:"video",upload(e,t,r,s){if(!e.isValid){r.texImage2D(t.target,0,t.internalFormat,1,1,0,t.format,t.type,null);return}at.upload(e,t,r,s)}};var bt={linear:9729,nearest:9728},ce={linear:{linear:9987,nearest:9985},nearest:{linear:9986,nearest:9984}},ct={"clamp-to-edge":33071,repeat:10497,"mirror-repeat":33648},ue={never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519};function St(e,t,r,s,o,i,n,a){let c=i;if(!a||e.addressModeU!=="repeat"||e.addressModeV!=="repeat"||e.addressModeW!=="repeat"){let u=ct[n?"clamp-to-edge":e.addressModeU],f=ct[n?"clamp-to-edge":e.addressModeV],h=ct[n?"clamp-to-edge":e.addressModeW];t[o](c,t.TEXTURE_WRAP_S,u),t[o](c,t.TEXTURE_WRAP_T,f),t.TEXTURE_WRAP_R&&t[o](c,t.TEXTURE_WRAP_R,h)}if((!a||e.magFilter!=="linear")&&t[o](c,t.TEXTURE_MAG_FILTER,bt[e.magFilter]),r){if(!a||e.mipmapFilter!=="linear"){let u=ce[e.minFilter][e.mipmapFilter];t[o](c,t.TEXTURE_MIN_FILTER,u)}}else t[o](c,t.TEXTURE_MIN_FILTER,bt[e.minFilter]);if(s&&e.maxAnisotropy>1){let u=Math.min(e.maxAnisotropy,t.getParameter(s.MAX_TEXTURE_MAX_ANISOTROPY_EXT));t[o](c,s.TEXTURE_MAX_ANISOTROPY_EXT,u)}e.compare&&t[o](c,t.TEXTURE_COMPARE_FUNC,ue[e.compare])}function fe(e){return{r8unorm:e.RED,r8snorm:e.RED,r8uint:e.RED,r8sint:e.RED,r16uint:e.RED,r16sint:e.RED,r16float:e.RED,rg8unorm:e.RG,rg8snorm:e.RG,rg8uint:e.RG,rg8sint:e.RG,r32uint:e.RED,r32sint:e.RED,r32float:e.RED,rg16uint:e.RG,rg16sint:e.RG,rg16float:e.RG,rgba8unorm:e.RGBA,"rgba8unorm-srgb":e.RGBA,rgba8snorm:e.RGBA,rgba8uint:e.RGBA,rgba8sint:e.RGBA,bgra8unorm:e.RGBA,"bgra8unorm-srgb":e.RGBA,rgb9e5ufloat:e.RGB,rgb10a2unorm:e.RGBA,rg11b10ufloat:e.RGB,rg32uint:e.RG,rg32sint:e.RG,rg32float:e.RG,rgba16uint:e.RGBA,rgba16sint:e.RGBA,rgba16float:e.RGBA,rgba32uint:e.RGBA,rgba32sint:e.RGBA,rgba32float:e.RGBA,stencil8:e.STENCIL_INDEX8,depth16unorm:e.DEPTH_COMPONENT,depth24plus:e.DEPTH_COMPONENT,"depth24plus-stencil8":e.DEPTH_STENCIL,depth32float:e.DEPTH_COMPONENT,"depth32float-stencil8":e.DEPTH_STENCIL}}function me(e,t){let r={},s=e.RGBA;return e instanceof S.get().getWebGL2RenderingContext()?(r={"rgba8unorm-srgb":e.SRGB8_ALPHA8,"bgra8unorm-srgb":e.SRGB8_ALPHA8},s=e.RGBA8):t.srgb&&(r={"rgba8unorm-srgb":t.srgb.SRGB8_ALPHA8_EXT,"bgra8unorm-srgb":t.srgb.SRGB8_ALPHA8_EXT}),l(l(l(l(l(l(v(l({r8unorm:e.R8,r8snorm:e.R8_SNORM,r8uint:e.R8UI,r8sint:e.R8I,r16uint:e.R16UI,r16sint:e.R16I,r16float:e.R16F,rg8unorm:e.RG8,rg8snorm:e.RG8_SNORM,rg8uint:e.RG8UI,rg8sint:e.RG8I,r32uint:e.R32UI,r32sint:e.R32I,r32float:e.R32F,rg16uint:e.RG16UI,rg16sint:e.RG16I,rg16float:e.RG16F,rgba8unorm:e.RGBA},r),{rgba8snorm:e.RGBA8_SNORM,rgba8uint:e.RGBA8UI,rgba8sint:e.RGBA8I,bgra8unorm:s,rgb9e5ufloat:e.RGB9_E5,rgb10a2unorm:e.RGB10_A2,rg11b10ufloat:e.R11F_G11F_B10F,rg32uint:e.RG32UI,rg32sint:e.RG32I,rg32float:e.RG32F,rgba16uint:e.RGBA16UI,rgba16sint:e.RGBA16I,rgba16float:e.RGBA16F,rgba32uint:e.RGBA32UI,rgba32sint:e.RGBA32I,rgba32float:e.RGBA32F,stencil8:e.STENCIL_INDEX8,depth16unorm:e.DEPTH_COMPONENT16,depth24plus:e.DEPTH_COMPONENT24,"depth24plus-stencil8":e.DEPTH24_STENCIL8,depth32float:e.DEPTH_COMPONENT32F,"depth32float-stencil8":e.DEPTH32F_STENCIL8}),t.s3tc?{"bc1-rgba-unorm":t.s3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,"bc2-rgba-unorm":t.s3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT,"bc3-rgba-unorm":t.s3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT}:{}),t.s3tc_sRGB?{"bc1-rgba-unorm-srgb":t.s3tc_sRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,"bc2-rgba-unorm-srgb":t.s3tc_sRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT,"bc3-rgba-unorm-srgb":t.s3tc_sRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}:{}),t.rgtc?{"bc4-r-unorm":t.rgtc.COMPRESSED_RED_RGTC1_EXT,"bc4-r-snorm":t.rgtc.COMPRESSED_SIGNED_RED_RGTC1_EXT,"bc5-rg-unorm":t.rgtc.COMPRESSED_RED_GREEN_RGTC2_EXT,"bc5-rg-snorm":t.rgtc.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}:{}),t.bptc?{"bc6h-rgb-float":t.bptc.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT,"bc6h-rgb-ufloat":t.bptc.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT,"bc7-rgba-unorm":t.bptc.COMPRESSED_RGBA_BPTC_UNORM_EXT,"bc7-rgba-unorm-srgb":t.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT}:{}),t.etc?{"etc2-rgb8unorm":t.etc.COMPRESSED_RGB8_ETC2,"etc2-rgb8unorm-srgb":t.etc.COMPRESSED_SRGB8_ETC2,"etc2-rgb8a1unorm":t.etc.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,"etc2-rgb8a1unorm-srgb":t.etc.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,"etc2-rgba8unorm":t.etc.COMPRESSED_RGBA8_ETC2_EAC,"etc2-rgba8unorm-srgb":t.etc.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC,"eac-r11unorm":t.etc.COMPRESSED_R11_EAC,"eac-rg11unorm":t.etc.COMPRESSED_SIGNED_RG11_EAC}:{}),t.astc?{"astc-4x4-unorm":t.astc.COMPRESSED_RGBA_ASTC_4x4_KHR,"astc-4x4-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR,"astc-5x4-unorm":t.astc.COMPRESSED_RGBA_ASTC_5x4_KHR,"astc-5x4-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR,"astc-5x5-unorm":t.astc.COMPRESSED_RGBA_ASTC_5x5_KHR,"astc-5x5-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR,"astc-6x5-unorm":t.astc.COMPRESSED_RGBA_ASTC_6x5_KHR,"astc-6x5-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR,"astc-6x6-unorm":t.astc.COMPRESSED_RGBA_ASTC_6x6_KHR,"astc-6x6-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR,"astc-8x5-unorm":t.astc.COMPRESSED_RGBA_ASTC_8x5_KHR,"astc-8x5-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR,"astc-8x6-unorm":t.astc.COMPRESSED_RGBA_ASTC_8x6_KHR,"astc-8x6-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR,"astc-8x8-unorm":t.astc.COMPRESSED_RGBA_ASTC_8x8_KHR,"astc-8x8-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR,"astc-10x5-unorm":t.astc.COMPRESSED_RGBA_ASTC_10x5_KHR,"astc-10x5-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR,"astc-10x6-unorm":t.astc.COMPRESSED_RGBA_ASTC_10x6_KHR,"astc-10x6-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR,"astc-10x8-unorm":t.astc.COMPRESSED_RGBA_ASTC_10x8_KHR,"astc-10x8-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR,"astc-10x10-unorm":t.astc.COMPRESSED_RGBA_ASTC_10x10_KHR,"astc-10x10-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR,"astc-12x10-unorm":t.astc.COMPRESSED_RGBA_ASTC_12x10_KHR,"astc-12x10-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR,"astc-12x12-unorm":t.astc.COMPRESSED_RGBA_ASTC_12x12_KHR,"astc-12x12-unorm-srgb":t.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR}:{})}function _e(e){return{r8unorm:e.UNSIGNED_BYTE,r8snorm:e.BYTE,r8uint:e.UNSIGNED_BYTE,r8sint:e.BYTE,r16uint:e.UNSIGNED_SHORT,r16sint:e.SHORT,r16float:e.HALF_FLOAT,rg8unorm:e.UNSIGNED_BYTE,rg8snorm:e.BYTE,rg8uint:e.UNSIGNED_BYTE,rg8sint:e.BYTE,r32uint:e.UNSIGNED_INT,r32sint:e.INT,r32float:e.FLOAT,rg16uint:e.UNSIGNED_SHORT,rg16sint:e.SHORT,rg16float:e.HALF_FLOAT,rgba8unorm:e.UNSIGNED_BYTE,"rgba8unorm-srgb":e.UNSIGNED_BYTE,rgba8snorm:e.BYTE,rgba8uint:e.UNSIGNED_BYTE,rgba8sint:e.BYTE,bgra8unorm:e.UNSIGNED_BYTE,"bgra8unorm-srgb":e.UNSIGNED_BYTE,rgb9e5ufloat:e.UNSIGNED_INT_5_9_9_9_REV,rgb10a2unorm:e.UNSIGNED_INT_2_10_10_10_REV,rg11b10ufloat:e.UNSIGNED_INT_10F_11F_11F_REV,rg32uint:e.UNSIGNED_INT,rg32sint:e.INT,rg32float:e.FLOAT,rgba16uint:e.UNSIGNED_SHORT,rgba16sint:e.SHORT,rgba16float:e.HALF_FLOAT,rgba32uint:e.UNSIGNED_INT,rgba32sint:e.INT,rgba32float:e.FLOAT,stencil8:e.UNSIGNED_BYTE,depth16unorm:e.UNSIGNED_SHORT,depth24plus:e.UNSIGNED_INT,"depth24plus-stencil8":e.UNSIGNED_INT_24_8,depth32float:e.FLOAT,"depth32float-stencil8":e.FLOAT_32_UNSIGNED_INT_24_8_REV}}var Ie=4,H=class{constructor(t){this.managedTextures=[],this._glTextures=Object.create(null),this._glSamplers=Object.create(null),this._boundTextures=[],this._activeTextureLocation=-1,this._boundSamplers=Object.create(null),this._uploads={image:at,buffer:ie,video:ae,compressed:ne},this._useSeparateSamplers=!1,this._renderer=t}contextChange(t){this._gl=t,this._mapFormatToInternalFormat||(this._mapFormatToInternalFormat=me(t,this._renderer.context.extensions),this._mapFormatToType=_e(t),this._mapFormatToFormat=fe(t)),this._glTextures=Object.create(null),this._glSamplers=Object.create(null),this._boundSamplers=Object.create(null);for(let r=0;r<16;r++)this.bind(E.EMPTY,r)}initSource(t){this.bind(t)}bind(t,r=0){let s=t.source;t?(this.bindSource(s,r),this._useSeparateSamplers&&this._bindSampler(s.style,r)):(this.bindSource(null,r),this._useSeparateSamplers&&this._bindSampler(null,r))}bindSource(t,r=0){let s=this._gl;if(t._touched=this._renderer.textureGC.count,this._boundTextures[r]!==t){this._boundTextures[r]=t,this._activateLocation(r),t=t||E.EMPTY.source;let o=this.getGlSource(t);s.bindTexture(o.target,o.texture)}}_bindSampler(t,r=0){let s=this._gl;if(!t){this._boundSamplers[r]=null,s.bindSampler(r,null);return}let o=this._getGlSampler(t);this._boundSamplers[r]!==o&&(this._boundSamplers[r]=o,s.bindSampler(r,o))}unbind(t){let r=t.source,s=this._boundTextures,o=this._gl;for(let i=0;i<s.length;i++)if(s[i]===r){this._activateLocation(i);let n=this.getGlSource(r);o.bindTexture(n.target,null),s[i]=null}}_activateLocation(t){this._activeTextureLocation!==t&&(this._activeTextureLocation=t,this._gl.activeTexture(this._gl.TEXTURE0+t))}_initSource(t){let r=this._gl,s=new nt(r.createTexture());if(s.type=this._mapFormatToType[t.format],s.internalFormat=this._mapFormatToInternalFormat[t.format],s.format=this._mapFormatToFormat[t.format],t.autoGenerateMipmaps&&(this._renderer.context.supports.nonPowOf2mipmaps||t.isPowerOfTwo)){let o=Math.max(t.width,t.height);t.mipLevelCount=Math.floor(Math.log2(o))+1}return this._glTextures[t.uid]=s,this.managedTextures.includes(t)||(t.on("update",this.onSourceUpdate,this),t.on("resize",this.onSourceUpdate,this),t.on("styleChange",this.onStyleChange,this),t.on("destroy",this.onSourceDestroy,this),t.on("unload",this.onSourceUnload,this),t.on("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.push(t)),this.onSourceUpdate(t),this.updateStyle(t,!1),s}onStyleChange(t){this.updateStyle(t,!1)}updateStyle(t,r){let s=this._gl,o=this.getGlSource(t);s.bindTexture(s.TEXTURE_2D,o.texture),this._boundTextures[this._activeTextureLocation]=t,St(t.style,s,t.mipLevelCount>1,this._renderer.context.extensions.anisotropicFiltering,"texParameteri",s.TEXTURE_2D,!this._renderer.context.supports.nonPowOf2wrapping&&!t.isPowerOfTwo,r)}onSourceUnload(t){let r=this._glTextures[t.uid];r&&(this.unbind(t),this._glTextures[t.uid]=null,this._gl.deleteTexture(r.texture))}onSourceUpdate(t){let r=this._gl,s=this.getGlSource(t);r.bindTexture(r.TEXTURE_2D,s.texture),this._boundTextures[this._activeTextureLocation]=t,this._uploads[t.uploadMethodId]?this._uploads[t.uploadMethodId].upload(t,s,r,this._renderer.context.webGLVersion):r.texImage2D(r.TEXTURE_2D,0,r.RGBA,t.pixelWidth,t.pixelHeight,0,r.RGBA,r.UNSIGNED_BYTE,null),t.autoGenerateMipmaps&&t.mipLevelCount>1&&this.onUpdateMipmaps(t,!1)}onUpdateMipmaps(t,r=!0){r&&this.bindSource(t,0);let s=this.getGlSource(t);this._gl.generateMipmap(s.target)}onSourceDestroy(t){t.off("destroy",this.onSourceDestroy,this),t.off("update",this.onSourceUpdate,this),t.off("resize",this.onSourceUpdate,this),t.off("unload",this.onSourceUnload,this),t.off("styleChange",this.onStyleChange,this),t.off("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.splice(this.managedTextures.indexOf(t),1),this.onSourceUnload(t)}_initSampler(t){let r=this._gl,s=this._gl.createSampler();return this._glSamplers[t._resourceId]=s,St(t,r,this._boundTextures[this._activeTextureLocation].mipLevelCount>1,this._renderer.context.extensions.anisotropicFiltering,"samplerParameteri",s,!1,!0),this._glSamplers[t._resourceId]}_getGlSampler(t){return this._glSamplers[t._resourceId]||this._initSampler(t)}getGlSource(t){return this._glTextures[t.uid]||this._initSource(t)}generateCanvas(t){let{pixels:r,width:s,height:o}=this.getPixels(t),i=S.get().createCanvas();i.width=s,i.height=o;let n=i.getContext("2d");if(n){let a=n.createImageData(s,o);a.data.set(r),n.putImageData(a,0,0)}return i}getPixels(t){let r=t.source.resolution,s=t.frame,o=Math.max(Math.round(s.width*r),1),i=Math.max(Math.round(s.height*r),1),n=new Uint8Array(Ie*o*i),a=this._renderer,c=a.renderTarget.getRenderTarget(t),u=a.renderTarget.getGpuRenderTarget(c),f=a.gl;return f.bindFramebuffer(f.FRAMEBUFFER,u.resolveTargetFramebuffer),f.readPixels(Math.round(s.x*r),Math.round(s.y*r),o,i,f.RGBA,f.UNSIGNED_BYTE,n),{pixels:new Uint8ClampedArray(n.buffer),width:o,height:i}}destroy(){this.managedTextures.slice().forEach(t=>this.onSourceDestroy(t)),this.managedTextures=null,this._renderer=null}};H.extension={type:[m.WebGLSystem],name:"texture"};var De=[...Nt,O,wt,Ft,D,H,F,C,L,M,G,oe,P,U],Ce=[...yt],Ue=[y,N,B],le=[],de=[],pe=[];A.handleByNamedList(m.WebGLSystem,le);A.handleByNamedList(m.WebGLPipes,de);A.handleByNamedList(m.WebGLPipesAdaptor,pe);A.add(...De,...Ce,...Ue);var he=class extends At{constructor(){let t={name:"webgl",type:vt.WEBGL,systems:le,renderPipes:de,renderPipeAdaptors:pe};super(t)}};export{he as a};
